
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQ-zmK2ZkGddWsFDy_cPz4TwLJOYvZD7o&&libraries=places"></script>
@Scripts.Render("~/bundles/selectize")
@Styles.Render("~/plugins/selectize")

<div class="modal fade" id="addOrderModal" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                <h4 class="modal-title" id="Heading">Add New Order</h4>
            </div>

            <div class="modal-body">
                <form class="form-horizontal" id="submitOrder">
                    <div class="form-group">
                        <label for="customerName" class="col-sm-3 col-md-3 control-label">Customer Name</label>
                        <div class="col-sm-9 col-md-9">
                            <input type="text" class="form-control" id="customerName" name="CustomerName" placeholder="Customer Name" pattern="[A-Za-z]{3}">
                            <span class="message-icon glyphicon"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customerPhone" class="col-sm-3 col-md-3 control-label">Customer Phone</label>
                        <div class="col-sm-9 col-md-9">
                            <input type="number" class="form-control" id="customerPhone" name="CustomerNumber" placeholder="Customer Phone Number">
                            <span class="message-icon glyphicon"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="timeToReachPickUpLocation" class="col-sm-3 col-md-3 control-label">Time To Reach PickUp Location</label>
                        <div class="col-sm-9 col-md-9">
                            <input type="text" class="form-control" id="timeToReachPickUpLocation" name="TimeToReachPickUpLocation" placeholder="Time To Reach PickUp Location">
                            <span class="message-icon glyphicon"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="timeToReachDropOffLocation" class="col-sm-3 col-md-3 control-label">Time To Reach DropOff Location</label>
                        <div class="col-sm-9 col-md-9">
                            <input type="text" class="form-control" id="timeToReachDropOffLocation" name="TimeToReachDropOffLocation" placeholder="Time To Reach DropOff Location">
                            <span class="message-icon glyphicon"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pickUpLocation" class="col-sm-3 col-md-3 control-label">Pick Up Location</label>
                        <div class="col-sm-9 col-md-9">
                            <input type="text" class="form-control" id="pickUpLocation" name="PickUpLocation" placeholder="Pick Up Location">
                            <span class="message-icon glyphicon"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="dropOffLocation" class="col-sm-3 col-md-3 control-label">Drop Off Location</label>
                        <div class="col-sm-9 col-md-9">
                            <input type="text" class="form-control" id="dropOffLocation" name="DropOffLocation" placeholder="Drop Off Location">
                            <span class="message-icon glyphicon"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="orderNumber" class="col-sm-3 col-md-3 control-label">Order Number</label>
                        <div class="col-sm-9 col-md-9">
                            <input type="text" class="form-control" id="orderNumber" name="OrderNumber" placeholder="Unique Order number">
                            <span class="message-icon glyphicon"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="vehicleType" class="col-sm-3 col-md-3 control-label">Vehicle Type</label>
                        <div class="col-sm-9 col-md-9">
                            <input type="text" class="form-control" id="vehicleType" name="VehicleType" required />
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="">
                            <div id="map_canvas" style="width: 100%; height: 300px"></div>
                        </div>
                    </div>
                </form>

                <div class="modal-footer ">
                    <ul class="list-inline pull-right">
                        <li><button type="submit" class="btn btn-warning" data-dismiss="modal">Close</button></li>
                        <li><button type="button" class="btn btn-primary" id="addOrderBtn">Add Order</button></li>
                    </ul>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
</div>
<style></style>
<script>
    $("#vehicleType").selectize({
        searchField: ['text'],
        maxItems: 1,
        allowEmptyOption: false,
        plugins: ['remove_button'],
        preload: true,
        load: function (query, callback) {
            $.post("/home/GetVehicleTypes")
                .done(function (data) {
                    if (data !== '') {
                        callback(data);
                    }
                }).fail(function (xmlHttpRequest, textStatus, errorThrown) {
                });
        }
    });

    var rideType;
    var source, destination;
    var directionsDisplay;
    var map;
    var directionsService = new google.maps.DirectionsService();
    var mapElement = document.getElementById('map_canvas');
    function getMapStart() {
        return {
            zoom: 12,
            center: new window.google.maps.LatLng(51.5076514, -0.1256326),
            styles: [
                        {
                            "featureType": "water",
                            "stylers": [
                                { "saturation": 43 },
                                { "lightness": -11 },
                                { "hue": "#0088ff" }
                            ]
                        },
                        {
                            "featureType": "road",
                            "elementType": "geometry.fill",
                            "stylers": [
                                { "hue": "#ff0000" },
                                { "saturation": -100 },
                                { "lightness": 99 }
                            ]
                        },
                        {
                            "featureType": "road",
                            "elementType": "geometry.stroke",
                            "stylers": [
                                { "color": "#808080" },
                                { "lightness": 54 }
                            ]
                        },
                        {
                            "featureType": "landscape.man_made",
                            "elementType": "geometry.fill",
                            "stylers": [
                                { "color": "#ece2d9" }
                            ]
                        },
                        {
                            "featureType": "poi.park",
                            "elementType": "geometry.fill",
                            "stylers": [
                                { "color": "#ccdca1" }
                            ]
                        },
                        {
                            "featureType": "road",
                            "elementType": "labels.text.fill",
                            "stylers": [
                                { "color": "#767676" }
                            ]
                        },
                        {
                            "featureType": "road",
                            "elementType": "labels.text.stroke",
                            "stylers": [
                                { "color": "#ffffff" }
                            ]
                        },
                        {
                            "featureType": "poi",
                            "stylers": [
                                { "visibility": "off" }
                            ]
                        },
                        {
                            "featureType": "landscape.natural",
                            "elementType": "geometry.fill",
                            "stylers": [
                                { "visibility": "on" },
                                { "color": "#b8cb93" }
                            ]
                        },
                        {
                            "featureType": "poi.park",
                            "stylers": [
                                { "visibility": "on" }
                            ]
                        },
                        {
                            "featureType": "poi.sports_complex",
                            "stylers": [
                                { "visibility": "on" }
                            ]
                        },
                        {
                            "featureType": "poi.medical",
                            "stylers": [
                                { "visibility": "on" }
                            ]
                        },
                        {
                            "featureType": "poi.business",
                            "stylers": [
                                { "visibility": "simplified" }
                            ]
                        }]
        };
    }

    function ClearMap() {
        map = new window.google.maps.Map(mapElement, getMapStart());
        directionsDisplay.setMap(null);
    }

    function GetRoute() {
        var mapOptions = getMapStart();
        map = new window.google.maps.Map(document.getElementById('map_canvas'), mapOptions);
        directionsDisplay.setMap(map);

        source = $("#pickUpLocation").val();
        destination = $("#dropOffLocation").val();

        var request = {
            origin: source,
            destination: destination,
            travelMode: window.google.maps.TravelMode.DRIVING
        };
        directionsService.route(request, function (response, status) {
            if (status === window.google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
            }
        });

        var service = new window.google.maps.DistanceMatrixService();
        service.getDistanceMatrix({
            origins: [source],
            destinations: [destination],
            travelMode: window.google.maps.TravelMode.DRIVING,
            unitSystem: window.google.maps.UnitSystem.IMPERIAL,
            avoidHighways: false,
            avoidTolls: false
        }, function (response, status) {
            if (status === window.google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status === "OK") {
                // console.log(response.rows[0].elements[0]);

                var distanceToShow = response.rows[0].elements[0].distance.text;
                var durationToShow = response.rows[0].elements[0].duration.text;

                var distance = response.rows[0].elements[0].distance.value;
                var duration = response.rows[0].elements[0].duration.value;

                $("#distance").html(distanceToShow);
                $("#duration").html(durationToShow);

                $("#distance").data("value", distance);
                $("#duration").data("value", duration);


            } else {
                ClearMap();
            }
        });


    }


    function GetAddress() {
        var lat = parseFloat(document.getElementById("txtLatitude").value);
        var lng = parseFloat(document.getElementById("txtLongitude").value);
        var latlng = new window.google.maps.LatLng(lat, lng);
        var geocoder = geocoder = new window.google.maps.Geocoder();
        geocoder.geocode({ 'latLng': latlng }, function (results, status) {
            if (status === window.google.maps.GeocoderStatus.OK) {
                if (results[1]) {
                    if (rideType === "pick")
                        $("#pickUpLocation").val(results[1].formatted_address);
                    else
                        $("#dropOffLocation").val(results[1].formatted_address);
                    GetRoute();
                }
            }
        });
    }




    $('#pickUpLocation').blur(function () {
        if ($('#pickUpLocation').val() === "") {
            ClearMap();
        } else {
            GetRoute();
        }
    });

    $('#pickUpLocation').keyup(function (e) {
        var code = e.which; // recommended to use e.which, it's normalized across browsers
        if (code === 13) {
            if ($('#pickUpLocation').val() === "") {
                ClearMap();
            } else {
                GetRoute();
            }
        }
    });

    $('#dropOffLocation').blur(function () {
        if ($('#dropOffLocation').val() === "") {
            ClearMap();
        } else {
            GetRoute();
        }
    });

    $('#dropOffLocation').keyup(function (e) {
        var code = e.which; // recommended to use e.which, it's normalized across browsers
        if (code === 13) {
            if ($('#dropOffLocation').val() === "") {
                ClearMap();
            } else {
                GetRoute();
            }
        }
    });


    $("#addOrderModal").on("shown.bs.modal",
        function() {
            var mapOptions = getMapStart();
            var sourceSearchBox = new window.google.maps.places.SearchBox($('#pickUpLocation')[0]);
            sourceSearchBox.addListener('places_changed', function () {
                var places = sourceSearchBox.getPlaces();
                if (places.length === 0) {
                    $("#pickUpLocation").css({ "border": "1px solid red", "background": "#FFCECE" });
                }
                else {
                    $("#pickUpLocation").css({ "background": "", "border": "1px solid #D5D5D5" });

                }
            });
            var destinationSearchBox = new window.google.maps.places.SearchBox($('#dropOffLocation')[0]);
            destinationSearchBox.addListener('places_changed', function () {
                var places = destinationSearchBox.getPlaces();
                if (places.length === 0) {
                    $("#dropOffLocation").css({ "border": "1px solid red", "background": "#FFCECE" });
                }
                else {
                    $("#dropOffLocation").css({ "background": "", "border": "1px solid #D5D5D5" });

                }
            });
            directionsDisplay = new window.google.maps.DirectionsRenderer({
                'draggable': false
            });

            var map = new window.google.maps.Map(document.getElementById("map_canvas"), mapOptions);
        });


</script>
